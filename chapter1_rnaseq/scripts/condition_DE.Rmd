---
title: "Corkwing wrasse DE analysis with condition model"
output:
  html_document:
    toc: true
    toc_float: true
date: "2025-10-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


# Differential Expression Analysis with condition model


## Setup and Package Loading

```{r packages, results='hide'}
# Set root directory
here::i_am("scripts/condition_DE.Rmd")

suppressPackageStartupMessages({
  library(DESeq2)
  library(ashr)
  library(grid)
  library(VennDiagram)
  library(here)
})
```


## Data Import and Preprocessing

```{r load_data}

# Load abundance matrix, sample information and temperature contrasts

abundance_matrix <- read.table(here("data", "DE", "abundance_matrix.txt"), header = TRUE, row.names = 1)

sample_info <- read.table(
  here("data", "DE", "samples.txt"),
  header = FALSE,
  col.names = c("condition", "sample")
)

contrasts_temp <- read.table(
  here("data", "DE", "contrast_temp.txt"),
  header = FALSE,
  col.names = c("condition1", "condition2")
)


contrasts_origin <- read.table(
  here("data", "DE", "contrast_origin.txt"),
  header = FALSE,
  col.names = c("condition1", "condition2")
)

```


## Prepare dataset and run DESeq2 

```{r dataset_DESeq2}
# Prepare DESeq2 dataset
colnames(abundance_matrix) <- sample_info$sample
abundance_matrix <- round(pmax(abundance_matrix, 0))  # Ensure non-negative integers

dds <- DESeqDataSetFromMatrix(
  countData = abundance_matrix,
  colData = sample_info,
  design = ~ condition
)

dds <- dds[rowSums(counts(dds)) >= 10, ]
dds <- DESeq(dds)

```


## Define threshold for significantly expressed genes

```{r define_threshold}
alpha <- 0.05   # alpha sets the adjusted p-value cutoff (false discovery rate) for statistical significance.
lfcThreshold <- 0 # lfcThreshold sets the minimum absolute log2 fold change 

```


## Function to extract, save and plot results for pairwise contrasts with shrinkage

```{r helper_DESeq2_contrast_and_plots}
# Function to run contrast analysis and save results
run_contrast_analysis <- function(contrast_table, contrast_type, output_dir) {
  results_list <- list()
  counts_summary <- data.frame(
    Comparison = character(),
    Upregulated = integer(),
    Downregulated = integer(),
    stringsAsFactors = FALSE
  )

  dir.create(here(output_dir), recursive = TRUE, showWarnings = FALSE)

  for (i in 1:nrow(contrast_table)) {
    condition1 <- contrast_table$condition1[i]
    condition2 <- contrast_table$condition2[i]
    name <- paste(condition1, "vs", condition2, sep = "_")

    res <- lfcShrink(
      dds,
      contrast = c("condition", condition1, condition2),
      type = "normal"
    )

    results_list[[name]] <- res

    sig <- res[which(res$padj < alpha & abs(res$log2FoldChange) > lfcThreshold), ]
    up <- sum(sig$log2FoldChange > 0)
    down <- sum(sig$log2FoldChange < 0)

    write.csv(as.data.frame(res), file = here(output_dir, paste0(name, "_DE_results.csv")), row.names = TRUE)
    write.csv(as.data.frame(sig), file = here(output_dir, paste0(name, "_significant_transcripts.csv")), row.names = TRUE)

    # Save MA plot to PNG
    png(filename = here(output_dir, paste0(name, "_MA_plot.png")), width = 800, height = 600)
    plotMA(res, ylim = c(-10, 10), main = paste("MA Plot:", name), alpha = alpha, colSig = "red")
    text(x = max(res$baseMean, na.rm = TRUE) * 0.7, y = 9, labels = paste("↑:", up), col = "blue", cex = 0.8)
    text(x = max(res$baseMean, na.rm = TRUE) * 0.7, y = -9, labels = paste("↓:", down), col = "blue", cex = 0.8)
    dev.off()

    # Show MA plot inline
    plotMA(res, ylim = c(-10, 10), main = paste("MA Plot:", name), alpha = alpha, colSig = "red")
    text(x = max(res$baseMean, na.rm = TRUE) * 0.7, y = 9, labels = paste("↑:", up), col = "blue", cex = 0.8)
    text(x = max(res$baseMean, na.rm = TRUE) * 0.7, y = -9, labels = paste("↓:", down), col = "blue", cex = 0.8)


    counts_summary <- rbind(counts_summary, data.frame(
      Comparison = name,
      Upregulated = up,
      Downregulated = down
    ))
  }

  return(list(results = results_list, summary = counts_summary))
}

```


## Extract, save and plot results for Temperature contrast

```{r temperature_contrast}
# Run temperature contrast analysis
temperature <- run_contrast_analysis(
  contrast_table = contrasts_temp,
  contrast_type = "temperature",
  output_dir = "results/DE/temperature_contrast"
)

print(temperature$summary)
```

## Extract, save and plot results for Origin contrast

```{r origin_contrast}
# Run origin contrast analysis
origin <- run_contrast_analysis(
  contrast_table = contrasts_origin,
  contrast_type = "origin",
  output_dir = "results/DE/origin_contrast"
)

print(origin$summary)
```



## Venn diagrams for DE transcripts

### Function to plot, save and display venn diagrams
```{r helper_plot_venn, echo=TRUE, message=FALSE, warning=FALSE}
plot_venn <- function(transcript_lists, contrast_name, output_dir) {
  venn_plot <- venn.diagram(
    x = transcript_lists,
    category.names = names(transcript_lists),
    filename = NULL,
    fill = c("red", "green", "blue"),
    alpha = 0.5,
    cex = 2,
    fontface = "bold"
  )
  
  png(filename = here(output_dir, paste0("venn_", contrast_name, ".png")), width = 800, height = 800)
  grid.newpage()
  grid.draw(venn_plot)
  dev.off()
  
  grid.newpage()
  grid.draw(venn_plot)
}

```


### Temperature Contrast

#### Prepare sets of DE transcripts
```{r prepare_temperature_contrast_sets, echo=TRUE, message=FALSE, warning=FALSE}
prepare_temperature_contrast_sets <- function(prefixes) {
  labels <- c("South", "West", "Hybrid")
  files <- paste0(prefixes, "_significant_transcripts.csv")
  
  setNames(lapply(files, function(file) {
    rownames(read.csv(here("results", "DE", "temperature_contrast", file), row.names = 1))
  }), labels)
}

```

#### 12°C vs 15°C
```{r venn_temperature_12_vs_15, echo=TRUE, message=FALSE, warning=FALSE}

temp_12_vs_15 <- prepare_temperature_contrast_sets(c("S12_vs_S15", "W12_vs_W15", "H12_vs_H15"))
plot_venn(temp_12_vs_15, "temperature_12_vs_15", "results/DE/temperature_contrast")

```

#### 15°C vs 18°C
```{r venn_temperature_15_vs_18, echo=TRUE, message=FALSE, warning=FALSE}

temp_15_vs_18 <- prepare_temperature_contrast_sets(c("S15_vs_S18", "W15_vs_W18", "H15_vs_H18"))
plot_venn(temp_15_vs_18, "temperature_15_vs_18", "results/DE/temperature_contrast")

```

#### 12°C vs 18°C
```{r venn_temperature_12_vs_18, echo=TRUE, message=FALSE, warning=FALSE}

temp_12_vs_18 <- prepare_temperature_contrast_sets(c("S12_vs_S18", "W12_vs_W18", "H12_vs_H18"))
plot_venn(temp_12_vs_18, "temperature_12_vs_18", "results/DE/temperature_contrast")

```


### Origin contrast

#### Prepare sets of DE transcripts
```{r prepare_origin_contrast_sets, echo=TRUE, message=FALSE, warning=FALSE}
prepare_origin_contrast_sets <- function(prefixes) {
  labels <- c("12°C", "15°C", "18°C")
  files <- paste0(prefixes, "_significant_transcripts.csv")
  
  setNames(lapply(files, function(file) {
    rownames(read.csv(here("results", "DE", "origin_contrast", file), row.names = 1))
  }), labels)
}

```


#### South vs West
```{r venn_origin_south_vs_west, echo=TRUE, message=FALSE, warning=FALSE}

south_vs_west <- prepare_origin_contrast_sets(c("S12_vs_W12", "S15_vs_W15", "S18_vs_W18"))
plot_venn(south_vs_west, "south_vs_west", "results/DE/origin_contrast")
```

#### South vs Hybrid
```{r venn_origin_south_vs_hybrid, echo=TRUE, message=FALSE, warning=FALSE}
south_vs_hybrids <- prepare_origin_contrast_sets(c("S12_vs_H12", "S15_vs_H15", "S18_vs_H18"))
plot_venn(south_vs_hybrids, "south_vs_hybrids", "results/DE/origin_contrast")
```

#### West vs Hybrid
```{r venn_origin_west_vs_hybrid, echo=TRUE, message=FALSE, warning=FALSE}
west_vs_hybrids <- prepare_origin_contrast_sets(c("W12_vs_H12", "W15_vs_H15", "W18_vs_H18"))
plot_venn(west_vs_hybrids, "west_vs_hybrids", "results/DE/origin_contrast")

```




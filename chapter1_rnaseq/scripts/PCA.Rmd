---
title: "PCA"
author: "Carlota Myhre de Gouveia"
date: "2025-10-03"
  output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


## Setup and load required libraries
```{r packages, results='hide'}
# Set root directory
here::i_am("scripts/PCA.Rmd")

# Load libraries 
suppressPackageStartupMessages({
  library(DESeq2)
  library(ggplot2)
  library(here)
  library(dplyr)
  library(ggrepel) 
})
```

# Load data
```{r}
# Load abundance matrix and sample info
abundance_matrix <- read.table(here("data", "DE", "abundance_matrix.txt"), header = TRUE, row.names = 1)
sample_info <- read.table(
  here("data", "DE", "samples.txt"),
  header = FALSE,
  col.names = c("condition", "sample")
)

# Parse origin and temperature in sample_info
sample_info <- sample_info %>%
  mutate(
    origin = substr(condition, 1, 1),
    temperature = substr(condition, 2, nchar(condition))
  ) %>%
  mutate(
    origin = recode(origin, "W" = "West", "H" = "Hybrid", "S" = "South"),
    temperature = factor(temperature, levels = c("12", "15", "18")),
    origin = factor(origin, levels = c("Hybrid", "South", "West"))
  )

```

# Prepare DESeq2 object 
```{r}
# Prepare the DESeq2 dataset
colnames(abundance_matrix) <- sample_info$sample
abundance_matrix <- round(pmax(abundance_matrix, 0))  # Ensure non-negative integers

dds <- DESeqDataSetFromMatrix(
  countData = abundance_matrix,
  colData = sample_info,
  design = ~ origin + temperature
)

# Filter out low-count genes
dds <- dds[rowSums(counts(dds)) >= 10, ]

```

# Apply variance-stabilizing transformation (VST)
```{r}
# Apply variance-stabilizing transformation (VST) to normalize count data
vsd <- vst(dds, blind = TRUE)
```

# ## PCA using prcomp
```{r}
# Perform PCA on transposed VST matrix (samples as rows, transcripts as columns)
pca <- prcomp(t(assay(vsd)))

# Convert PCA results to data frame
pcaData <- as.data.frame(pca$x)

# Add sample names and metadata to PCA data
pcaData$Sample <- colnames(vsd)
pcaData <- cbind(pcaData, as.data.frame(colData(vsd)))

# Calculate percentage of variance explained by each PC
percentVar <- round(100 * (pca$sdev^2 / sum(pca$sdev^2)), 1)

```

## Plot PCA 
```{r}
# Define which PC combinations to plot
pc_combos <- list(
  c(1, 2),
  c(1, 3),
  c(2, 3),
  c(3, 4)
)

# Loop through each PC pair and generate a plot
for (combo in pc_combos) {
  x_pc <- combo[1]
  y_pc <- combo[2]
  
  # Create PCA scatter plot with color by temperature and shape by origin
  p <- ggplot(pcaData, aes_string(x = paste0("PC", x_pc), y = paste0("PC", y_pc),
                                  color = "temperature", shape = "origin")) +
    geom_point(size = 3) +  # Plot points only (no labels)
    xlab(paste0("PC", x_pc, ": ", percentVar[x_pc], "% variance")) +
    ylab(paste0("PC", y_pc, ": ", percentVar[y_pc], "% variance")) +
    ggtitle(paste0("PCA of Corkwing Wrasse RNA-seq (PC", x_pc, " vs PC", y_pc, ")")) +
    theme_minimal() +
    scale_color_manual(values = c("12" = "blue", "15" = "green", "18" = "red")) +
    scale_shape_manual(values = c("Hybrid" = 16, "South" = 17, "West" = 18))
  
  # Display the plot
  print(p)
  
  # Save the plot to file
 ggsave(
    filename = here("results", "PCA", paste0("PCA_PC", x_pc, "_vs_PC", y_pc, ".png")),
    plot = p, width = 8, height = 6, dpi = 300
  )
}

```

```{r}
# Define PC combinations to plot
pc_combos <- list(
  c(1, 2),
  c(1, 3),
  c(2, 3),
  c(3, 4),
  c(1,5),
  c(4,5),
  c(2,5),
  c(5,6), # Clear outlier behavior of some hybrid individuals
  c(5,7)
)

# Loop through each PC pair and generate a plot
for (combo in pc_combos) {
  x_pc <- combo[1]
  y_pc <- combo[2]
  
  # Create PCA scatter plot with color = origin, shape = temperature
  p <- ggplot(pcaData, aes_string(x = paste0("PC", x_pc), y = paste0("PC", y_pc),
                                  color = "origin", shape = "temperature")) +
    geom_point(size = 3) +  # Plot points only (no labels)
    xlab(paste0("PC", x_pc, ": ", percentVar[x_pc], "% variance")) +
    ylab(paste0("PC", y_pc, ": ", percentVar[y_pc], "% variance")) +
    ggtitle(paste0("PCA of Corkwing Wrasse RNA-seq (PC", x_pc, " vs PC", y_pc, ")")) +
    theme_minimal() +
    scale_color_manual(values = c("Hybrid" = "purple", "South" = "orange", "West" = "darkgreen")) +
    scale_shape_manual(values = c("12" = 16, "15" = 17, "18" = 18))  # Circle, triangle, diamond
  
  # Display the plot
  print(p)
  
}

```


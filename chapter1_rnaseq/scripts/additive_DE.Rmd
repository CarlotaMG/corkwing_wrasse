---
title: "Differential Expression Analysis of Corwing Wrasse"
author: "Carlota Myhre de Gouveia"
date: "2025-10-03"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Differential Expression Analysis with additive model

## Setup and Package Loading
```{r packages}
# Set root directory
here::i_am("scripts/additive_DE.Rmd")

# Load necessary packages
suppressPackageStartupMessages({
  library(tidyverse)
  library(DESeq2)
  library(apeglm)
  library(ashr)
  library(grid)
  library(VennDiagram)
  library(here)
})
```


## Data Import and Preprocessing
```{r load_data}

# Load abundance matrix and sample information 

abundance_matrix <- read.table(here::here("data", "DE", "abundance_matrix.txt"), header = TRUE, row.names = 1)
head(abundance_matrix)

sample_info <- read.table(
  here::here("data", "DE", "samples.txt"),
  header = FALSE,
  col.names = c("condition", "sample")
)
sample_info

```

## Prepare dataset and run DESeq2
```{r dataset_DESeq2_run}

# Parse temperature and origin from condition string. Assumes condition is formatted like "W12", "S15", etc.
sample_info <- sample_info %>%
  mutate(
    origin = substr(condition, 1, 1),
    temperature = substr(condition, 2, nchar(condition))
  ) %>%
  mutate(
    origin = recode(origin, "W" = "West", "H" = "Hybrid", "S" = "South"),
    temperature = factor(temperature, levels = c("12", "15", "18")),
    origin = factor(origin)
  )


# Ensure column names of count matrix match sample names
colnames(abundance_matrix) <- sample_info$sample

# Round counts and ensure non-negative integers (required by DESeq2)
abundance_matrix <- round(pmax(abundance_matrix, 0))  

# Create DESeq2 dataset with additive model (temperature + origin) 
dds <- DESeqDataSetFromMatrix(
  countData = abundance_matrix,
  colData = sample_info,
  design = ~ temperature + origin
)

# Filter out lowly expressed transcripts (keep those with total count ≥ 10 across all sampl
dds <- dds[rowSums(counts(dds)) >= 10, ]
# Run DESeq2 pipeline (estimate size factors, dispersions, and fit model)
dds <- DESeq(dds)
# Extract coefficient names for downstream contrasts
coef_names <- resultsNames(dds)

# Plot dispersion estimates across transcripts to assess fit to the negative binomial model used by DESeq2
plotDispEsts(dds)

```

## Define contrasts
```{r define_contrasts}

# Temperature contrasts (across all origins)
temperature_levels <- levels(sample_info$temperature)
temperature_contrasts <- t(combn(temperature_levels, 2))
colnames(temperature_contrasts) <- c("condition1", "condition2")
temperature_contrasts <- as.data.frame(temperature_contrasts)
temperature_contrasts

# Origin contrasts (across all temperatures)
origin_levels <- levels(sample_info$origin)
origin_contrasts <- t(combn(origin_levels, 2))
colnames(origin_contrasts) <- c("condition1", "condition2")
origin_contrasts <- as.data.frame(origin_contrasts)
origin_contrasts
```

## Helper function to check if a contrast corresponds to a direct coefficient in the DESeq2 model.
```{r is_direct_coef_function}
# Determines whether the comparison involves the reference level provided by DESeq2 as a coefficient. This determines whether we can use 'coef' (apeglm) or need to use 'contrast' (normal).
is_direct_coef <- function(factor_name, level1, level2, coef_names) {
  ref <- levels(sample_info[[factor_name]])[1]
  if (level2 == ref) {
    coef_pattern <- paste0(factor_name, "_", level1, "_vs_", ref)
    return(coef_pattern %in% coef_names)
  } else if (level1 == ref) {
    coef_pattern <- paste0(factor_name, "_", level2, "_vs_", ref)
    return(coef_pattern %in% coef_names)
  }
  return(FALSE)
}

```


## Main function to run pairwise differential expression analysis for a given factor (e.g., temperature or origin). 
```{r main_function}
# Automatically selects shrinkage method based on whether the comparison involves the reference level. Saves full and significant results, generates MA plots, and returns a summary table
run_contrast_analysis <- function(contrast_table, factor_name, output_dir, alpha = 0.05, lfcThreshold = 0.0, coef_names) {
  results_list <- list()
  counts_summary <- data.frame(
    Comparison = character(),
    Shrinkage = character(),
    Upregulated = integer(),
    Downregulated = integer(),
    stringsAsFactors = FALSE
  )
  # Create output directory if it doesn't exist
  dir.create(here::here(output_dir), recursive = TRUE, showWarnings = FALSE)
  
  for (i in 1:nrow(contrast_table)) {
    level1 <- contrast_table$condition1[i]
    level2 <- contrast_table$condition2[i]
    name <- paste(level2, "vs", level1, sep = "_")
    
    
    # Check if the comparison involves the reference level provided by DESeq2 as a coefficient
    # Use 'coef' with apeglm shrinkage for reference-level comparisons; use 'contrast' with normal shrinkage     otherwise
    direct_coef <- is_direct_coef(factor_name, level1, level2, coef_names)
    
    if (direct_coef) {
      coef_name <- paste0(factor_name, "_", level2, "_vs_", levels(sample_info[[factor_name]])[1])
      res <- lfcShrink(dds, coef = coef_name, type = "apeglm")
      shrinkage <- "apeglm"
    } else {
      res <- lfcShrink(dds, contrast = c(factor_name, level2, level1), type = "normal")
      shrinkage <- "normal"
    }
    
    results_list[[name]] <- res
    
    # Extract significant transcripts based on adjusted p-value and log2 fold change threshold
    sig <- res[which(res$padj < alpha & abs(res$log2FoldChange) > lfcThreshold), ]
    up <- sum(sig$log2FoldChange > 0)
    down <- sum(sig$log2FoldChange < 0)
    
    # Save full and significant results to CSV
    write.csv(as.data.frame(res), file = here::here(output_dir, paste0(name, "_DE_results.csv")), row.names = TRUE)
    write.csv(as.data.frame(sig), file = here::here(output_dir, paste0(name, "_significant_transcripts.csv")), row.names = TRUE)
    
    # Generate and save MA plot with up/downregulated transcript counts
    png(filename = here::here(output_dir, paste0(name, "_MA_plot.png")), width = 800, height = 600)
    plotMA(res, ylim = c(-10, 10), main = paste("MA Plot:", name, "-", shrinkage), alpha = alpha, colSig = "red")
    text(x = max(res$baseMean, na.rm = TRUE) * 0.7, y = 9, labels = paste("↑:", up), col = "blue", cex = 0.8)
    text(x = max(res$baseMean, na.rm = TRUE) * 0.7, y = -9, labels = paste("↓:", down), col = "blue", cex = 0.8)
    dev.off()
    
    # Also display MA plot inline in the report
    plotMA(res, ylim = c(-10, 10), main = paste("MA Plot:", name, "-", shrinkage), alpha = alpha, colSig = "red")
    text(x = max(res$baseMean, na.rm = TRUE) * 0.7, y = 9, labels = paste("↑:", up), col = "blue", cex = 0.8)
    text(x = max(res$baseMean, na.rm = TRUE) * 0.7, y = -9, labels = paste("↓:", down), col = "blue", cex = 0.8)
    
    # Add summary row to the results table
    counts_summary <- rbind(counts_summary, data.frame(
      Comparison = name,
      Shrinkage = shrinkage,
      Upregulated = up,
      Downregulated = down
    ))
  }
  # Return list of DESeq2 results and summary tab
  return(list(results = results_list, summary = counts_summary))
}

```

## Temperature contrast
```{r temperature_contrast}
# Temperature contrasts
temperature_results <- run_contrast_analysis(
  contrast_table = temperature_contrasts,
  factor_name = "temperature",
  output_dir = "results/DE/temperature_contrast_additive_model",
  coef_names = coef_names
)
print(temperature_results$summary)

## Save summary table
write.csv(
  temperature_results$summary,
  here::here("results", "DE", "temperature_contrast_additive_model", "contrast_summary.csv"),
  row.names = FALSE
)

```

## Origin contrast
```{r origin_contrast}
# Origin contrast
origin_results <- run_contrast_analysis(
  contrast_table = origin_contrasts,
  factor_name = "origin",
  output_dir = "results/DE/origin_contrast_additive_model",
  coef_names = coef_names
)
print(origin_results$summary)

## Save summary table
write.csv(
  origin_results$summary,
  here::here("results", "DE", "origin_contrast_additive_model", "contrast_summary.csv"),
  row.names = FALSE
)
```


# Venn diagrams

## Define venn plotting function
```{r define_plot_venn_function}
# Plot Venn diagram to visualize overlap between sets of significant transcripts
plot_venn <- function(transcript_lists, contrast_name, output_dir) {
  venn_plot <- venn.diagram(
    x = transcript_lists,
    category.names = names(transcript_lists),
    filename = NULL,
    fill = c("red", "green", "blue"),
    alpha = 0.5,
    cex = 2,
    fontface = "bold"
  )
  
  png(filename = here::here(output_dir, paste0("venn_", contrast_name, ".png")), width = 800, height = 800)
  grid.newpage()
  grid.draw(venn_plot)
  dev.off()
  
  grid.newpage()
  grid.draw(venn_plot)
}

```

## Prepare DE transcripts sets and plot venn diagrams for temperature contrast
```{r temperature_venn}

# Prepare DE sets for temperature contrasts
temp_contrasts <- c("15_vs_12", "18_vs_15", "18_vs_12")
temp_sets <- setNames(lapply(temp_contrasts, function(name) {
  file <- here::here("results", "DE", "temperature_contrast_additive_model", paste0(name, "_significant_transcripts.csv"))
  rownames(read.csv(file, row.names = 1))
}), c("15 vs 12", "18 vs 15", "18 vs 12"))

# Plot Venn diagram
plot_venn(temp_sets, "temperature_contrasts", "results/DE/temperature_contrast_additive_model")

```

## Prepare DE transcripts sets and plot venn diagrams for origin contrast
```{r origin_venn}

# Prepare DE sets for origin contrasts
origin_contrasts <- c("South_vs_Hybrid", "West_vs_Hybrid", "West_vs_South")
origin_labels <- c("South vs Hybrid", "West vs Hybrid", "West vs South")

origin_sets <- setNames(lapply(seq_along(origin_contrasts), function(i) {
  file <- here::here("results", "DE", "origin_contrast_additive_model", paste0(origin_contrasts[i], "_significant_transcripts.csv"))
  rownames(read.csv(file, row.names = 1))
}), origin_labels)

# Plot Venn diagram
plot_venn(origin_sets, "origin_contrasts", "results/DE/origin_contrast_additive_model")

```

## Function to load transcript sets
```{r define_load_transcript_sets_function}

# Load significant transcript sets used to visualize shared and unique DE transcripts across conditions
load_transcript_sets <- function(contrast_names, contrast_dir) {
  sets <- list()
  for (name in contrast_names) {
    file <- here::here("results", "DE", contrast_dir, paste0(name, "_significant_transcripts.csv"))
    if (file.exists(file)) {
      df <- read.csv(file, row.names = 1)
      sets[[name]] <- rownames(df)
    } else {
      warning(paste("File not found:", file))
      sets[[name]] <- character(0)
    }
  }
  return(sets)
}

```

## Function to summarize Venn regions
```{r define_venn_summary_table_function}
# Summarize the number of transcripts in each Venn region (shared or unique across contrasts)
venn_summary_table <- function(sets) {
  all_genes <- unique(unlist(sets))
  summary <- sapply(all_genes, function(gene) {
    present_in <- names(sets)[sapply(sets, function(s) gene %in% s)]
    paste(sort(present_in), collapse = " & ")
  })
  as.data.frame(table(summary), stringsAsFactors = FALSE) |>
    setNames(c("Region", "Count")) |>
    dplyr::arrange(desc(Count))
}

```

## Temperature Venn summary
```{r temperature_venn_summary}
temp_contrasts <- c("15_vs_12", "18_vs_15", "18_vs_12")
temp_sets <- load_transcript_sets(temp_contrasts, "temperature_contrast_additive_model")
temp_venn_summary <- venn_summary_table(temp_sets)
print(temp_venn_summary)

# Save venn summary
write.csv(
  temp_venn_summary,
  here::here("results", "DE", "temperature_contrast_additive_model", "venn_summary.csv"),
  row.names = FALSE
)
```

## Origin Venn summary
```{r origin_venn_summary}
origin_contrasts <- c("South_vs_Hybrid", "West_vs_Hybrid", "West_vs_South")
origin_sets <- load_transcript_sets(origin_contrasts, "origin_contrast_additive_model")
origin_venn_summary <- venn_summary_table(origin_sets)
print(origin_venn_summary)

# Save venn summary
write.csv(
  origin_venn_summary,
  here::here("results", "DE", "origin_contrast_additive_model", "venn_summary.csv"),
  row.names = FALSE
)
```

# Transcript Extraction for functional enrichment

## Tier 1: Shared temperature-responsive transcripts across origins. Candidates for general temperature response. 

### Biological Rationale

Tier 1 identifies transcripts that are consistently regulated by temperature across all origins. By intersecting results from all pairwise temperature contrasts, this approach isolates genes involved in a general thermal response, independent of population-specific effects.

```{r extract_tier1_transcripts}

# Extract transcripts that are consistently DE across all temperature contrasts. 
tier1_transcripts <- Reduce(intersect, temp_sets)

# Save for functional enrichment
write.csv(
  data.frame(transcript_id = tier1_transcripts),
  here::here("results", "functional_enrichment", "tier1_shared_temperature_response", "tier1_shared_temperature_transcripts.csv"),
  row.names = FALSE
)
```


## Tier 2: Local adaptation candidates (constitutive + plasticity divergence)

### Biological Rationale

Tier 2 aims to identify transcripts that may be involved in **local adaptation** between corkwing wrasse populations. These candidates are defined by the **overlap between constitutive differences and interaction effects**:

- **Constitutive differences** are identified using the additive model (`~ origin + temperature`) by comparing origins (West vs South) while controlling for temperature. These represent **baseline expression differences** that are consistent across temperatures and may reflect fixed genetic divergence.

- **Interaction effects** are identified using a likelihood ratio test (LRT) comparing models with and without the `origin:temperature` interaction term. These transcripts show **origin-specific responses to temperature**, indicating **plasticity divergence**.

By intersecting these two sets, we isolate transcripts that are:
- **Diverged between origins**, and
- **Differentially responsive to temperature depending on origin**

This overlap represents the **strongest candidates for local adaptation**, as they combine fixed and environmentally responsive divergence.
```{r extract_tier2_transcripts}

# Load constitutive origin differences (South vs West)
constitutive_file <- here::here("results", "DE", "origin_contrast_additive_model", "West_vs_South_significant_transcripts.csv")
constitutive_transcripts <- rownames(read.csv(constitutive_file, row.names = 1))

# Load interaction effect transcripts from LRT script
interaction_file <- here::here("results", "DE", "interaction_effects", "significant_interaction_transcripts.csv")
interaction_transcripts <- rownames(read.csv(interaction_file, row.names = 1))

# Overlap = strongest candidates for local adaptation
tier2_transcripts <- intersect(constitutive_transcripts, interaction_transcripts)

# Save for functional enrichment
write.csv(
  data.frame(transcript_id = tier2_transcripts),
  here::here("results", "functional_enrichment", "tier2_local_adaptation", "tier2_local_adaptation_candidates.csv"),
  row.names = FALSE
)
```

**Tier 3: Hybrid misregulation**
Tier 3 is analyzed separately using the condition model, where each origin-temperature combination is treated as a distinct group. This approach identifies transcripts where hybrids differ from both parental origins at a given temperature. Misregulated transcripts can be further classified as transgressive or intermediate based on expression direction.

## Summary of Transcript Extraction
```{r transcript_summary}
data.frame(
  Tier = c("Tier 1", "Tier 2"),
  Transcripts = c(length(tier1_transcripts), length(tier2_transcripts))
)
```

# Summary

This script performs Tier 1 and Tier 2 differential expression analyses using an additive DESeq2 model to investigate temperature responses and local adaptation in *Symphodus melops*.
Pairwise temperature contrasts revealed 585 transcripts consistently regulated by temperature across all origins (Tier 1). For Tier 2, constitutive origin differences were defined using West vs South origin fish, and their overlap with transcripts showing origin-dependent temperature responses yielded 32 strong candidates for local adaptation. These transcript sets were extracted and saved for downstream functional enrichment.

# Session Info
```{r session_info} 
sessionInfo()
```